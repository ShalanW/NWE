<div fxLayout="column" fxLayoutAlign="space-between stretch">

  <div fxFlex="row" fxLayoutAlign="center center">

    <mat-card fxFlex.gt-sm="60" fxFlex.lt-md="100" fxLayout="column" fxLayoutAlign="center stretch">

      <div fxLayout="row" fxLayoutAlign=" center">
        <mat-form-field fxFlex>
          <mat-label>Select Customer</mat-label>
          <input
            (input)="runOtherStuff(secondPanel)"
            (keyup.escape)="onReset(secondPanel)"
            [(ngModel)]="filteredString"
            [matAutocomplete]="auto"
            matInput
            placeholder="Choose One"
            type="text">
          <mat-autocomplete #auto="matAutocomplete"
                            (optionSelected)="selectedCustomer = $event.option.value; runStuff(); firstPanel.close(); runHelper()"
                            [displayWith]="displayFn"
                            autoActiveFirstOption>
            <mat-option *ngFor="let customer of $customers | async | filterCustomer:filteredString"
                        [value]="customer">
              {{customer['customerName']}}
            </mat-option>
          </mat-autocomplete>


        </mat-form-field>

        <mat-icon (click)="onReset(secondPanel); auto.showPanel = false; ">clear</mat-icon>

        <div #deleteButton>
          <mat-icon (click)="confirmButtons.hidden = false; deleteButton.hidden = true">delete</mat-icon>
        </div>

        <div #confirmButtons [hidden]="true">
          <mat-icon (click)="confirmDelete.hidden = false; confirmButtons.hidden = true">check</mat-icon>
          <mat-icon (click)="confirmButtons.hidden = true; deleteButton.hidden = false">close</mat-icon>

        </div>
        <div #confirmDelete [hidden]="true">
          <mat-icon
            (click)="onDeleteCustomer(selectedCustomer, secondPanel); deleteButton.hidden = false; confirmDelete.hidden = true">
            ðŸš¨
          </mat-icon>
        </div>

      </div>


      <!--      <mat-form-field appearance="fill" fxFill>-->
      <!--        <mat-label>Choose a Customer</mat-label>-->
      <!--        <mat-select [(ngModel)]="selectedCustomer">-->
      <!--          <mat-option *ngFor="let customer of $customers | async "-->
      <!--                      [value]="customer">-->
      <!--            {{customer.customerName}}-->
      <!--          </mat-option>-->
      <!--        </mat-select>-->
      <!--      </mat-form-field>-->

      <mat-accordion>

        <mat-expansion-panel #firstPanel [disabled]="!!filteredString">
          <mat-expansion-panel-header>
            <mat-panel-title>
              New Customer
            </mat-panel-title>
            <mat-panel-description>


            </mat-panel-description>
          </mat-expansion-panel-header>

          <form [formGroup]="customerForm" class="login-form">
            <mat-form-field class="customer" fxFill>
              <mat-label>Customer</mat-label>
              <input autocomplete="off" formControlName="customerName" matInput
                     placeholder=" ðŸš¨ Copy DIRECTLY from Feenix ðŸš¨ " type="text">
            </mat-form-field>

            <mat-form-field>
              <mat-label>Hauler Start</mat-label>
              <input [matDatepicker]="picker1" formControlName="haulerApiDate" matInput>
              <mat-hint>MM/DD/YYYY</mat-hint>
              <mat-datepicker-toggle [for]="picker1" matSuffix></mat-datepicker-toggle>
              <mat-datepicker #picker1></mat-datepicker>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Customer Start</mat-label>
              <input [matDatepicker]="picker2" formControlName="customerApiDate" matInput>
              <mat-hint>MM/DD/YYYY</mat-hint>
              <mat-datepicker-toggle [for]="picker2" matSuffix></mat-datepicker-toggle>
              <mat-datepicker #picker2></mat-datepicker>
            </mat-form-field>

            <mat-form-field class="customer">
              <mat-label>API Rate</mat-label>
              <input autocomplete="off" formControlName="customerApiRate" matInput type="text">
            </mat-form-field>

          </form>


          <button (click)="onAddNewCustomer(); firstPanel.close()" color="primary" mat-raised-button>Add New Customer
          </button>


        </mat-expansion-panel>


        <mat-expansion-panel #secondPanel [disabled]="selectedCustomer.customerName === ''">

          <mat-expansion-panel-header>
            <mat-panel-title>
              New On-Call Account
            </mat-panel-title>
            <mat-panel-description>
              For: {{selectedCustomer.customerName}}
            </mat-panel-description>
          </mat-expansion-panel-header>

          <mat-card-title>Customer Info</mat-card-title>

          <div class="customer-info">


            <!--            <mat-form-field>-->
            <!--              <mat-label>Customer Start Date</mat-label>-->
            <!--              <input #customerStartDate-->
            <!--                     [matDatepicker]="picker"-->
            <!--                     [value]="selectedCustomer.customerApiDate"-->
            <!--                     matInput-->
            <!--              >-->
            <!--              <mat-hint>MM/DD/YYYY</mat-hint>-->
            <!--              <mat-datepicker-toggle [for]="picker" matSuffix></mat-datepicker-toggle>-->
            <!--              <mat-datepicker #picker></mat-datepicker>-->
            <!--            </mat-form-field>-->

            <!--            <input [value]="selectedCustomer.customerApiDate" type="date">-->
            <mat-form-field>
              <mat-label>Customer Start Date</mat-label>

              <input [(ngModel)]="nextNewCustomerStartDate" matInput type="date">
              <mat-hint>MM/DD/YYYY</mat-hint>


            </mat-form-field>

            <mat-form-field>

              <mat-label>Hauler Start Date</mat-label>
              <input [(ngModel)]="selectedCustomer.haulerApiDate" [matDatepicker]="picker4"
                     matInput>
              <mat-hint>MM/DD/YYYY</mat-hint>
              <mat-datepicker-toggle [for]="picker4" matSuffix></mat-datepicker-toggle>
              <mat-datepicker #picker4></mat-datepicker>
            </mat-form-field>


            <mat-form-field class="customer">
              <mat-label>API Rate</mat-label>
              <input [(ngModel)]="selectedCustomer.customerApiRate" autocomplete="off" matInput type="text">
            </mat-form-field>
            <button
              (click)="onUpdateCustomer(selectedCustomer, nextNewCustomerStartDate)"
              color="primary" mat-raised-button>Add/Update
            </button>
          </div>


          <mat-card-title>Service Info</mat-card-title>

          <!--          *ngIf="!selectedCustomer.customerApiDate || !selectedCustomer.haulerApiDate || !selectedCustomer.customerApiRate"-->


          <form [formGroup]="addressForm" class="login-form">


            <mat-form-field fxFill>
              <mat-label>Street Address</mat-label>
              <input autocomplete="off" formControlName="streetAddress" matInput>
            </mat-form-field>


            <div fxLayout="row">
              <mat-form-field fxFlex="50">
                <mat-label>City</mat-label>
                <input autocomplete="off" formControlName="city" matInput>
              </mat-form-field>

              <mat-form-field fxFlex="20">
                <mat-label>State</mat-label>
                <input autocomplete="off" formControlName="state" matInput>
              </mat-form-field>

              <mat-form-field fxFlex="30">
                <mat-label>Zip</mat-label>
                <input autocomplete="off" formControlName="zip" matInput>
              </mat-form-field>
            </div>


          </form>
          <form [formGroup]="accountForm" class="login-form" fxLayout="column">
            <div fxLayout="row">

              <mat-form-field class="account-type" fxFlex="20">
                <mat-label>Type</mat-label>
                <input autocomplete="off" formControlName="type" matInput type="text">
              </mat-form-field>

              <mat-form-field class="account-number" fxFlex="40">
                <mat-label>Account #</mat-label>
                <input autocomplete="off" formControlName="accountNumber" matInput type="text">
              </mat-form-field>

              <mat-form-field class="site-number" fxFlex="40">
                <mat-label>Site # or Sub Account #</mat-label>
                <input autocomplete="off" formControlName="siteNumber" matInput type="text">
              </mat-form-field>
            </div>
          </form>
          <form [formGroup]="containerForm" class="login-form" fxLayout="column">

            <mat-card-title>Container</mat-card-title>

            <mat-form-field>
              <mat-label>Count</mat-label>
              <input autocomplete="off" formControlName="count" matInput>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Size</mat-label>
              <input autocomplete="off" formControlName="size" matInput>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Unit</mat-label>
              <input autocomplete="off" formControlName="unit" matInput placeholder="Gal, etc.">
            </mat-form-field>

            <mat-form-field>
              <mat-label>Type</mat-label>
              <input autocomplete="off" formControlName="type" matInput placeholder="Tub, Box, etc.">
            </mat-form-field>


            <mat-form-field>
              <mat-label>Price Per Container</mat-label>
              <input autocomplete="off" formControlName="price" matInput>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Minimum Per Service</mat-label>
              <input autocomplete="off" formControlName="minimumPerService" matInput>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Frequency in Weeks</mat-label>
              <input autocomplete="off" formControlName="frequencyByWeeks" matInput>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Monthly Cost</mat-label>
              <input autocomplete="off" formControlName="monthlyCost" matInput>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Extra Boxes Cost Hauler</mat-label>
              <input autocomplete="off" formControlName="extraBoxCostHauler" matInput>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Extra Boxes Cost Customer (Start)</mat-label>
              <input autocomplete="off" formControlName="extraBoxCostCustomerOriginal" matInput>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Extra Boxes Cost Customer (Current)</mat-label>
              <input autocomplete="off" formControlName="extraBoxCostCustomer" matInput>
            </mat-form-field>

          </form>


          <button (click)="onAddNewAccount(); secondPanel.close()" [disabled]="!selectedCustomer.customerName"
                  color="primary"
                  mat-raised-button>Add Account
          </button>

        </mat-expansion-panel>

      </mat-accordion>

    </mat-card>

  </div>

</div>


<div fxLayout="column" fxLayoutAlign="space-between stretch">

  <div fxFlex="row" fxLayoutAlign="center center">
    <mat-card fxFlex.gt-sm="60" fxFlex.lt-md="100" fxLayout="column" fxLayoutAlign="center stretch">


      <mat-card-content *ngFor="let customer of $selectedCustomer | async">

        <mat-tab-group>

          <mat-tab *ngFor="let accounts of customer.accounts"
                   label="{{customer.customerName}}{{' - '}}{{accounts.type}}">

            <div class="service-box" fxLayout="column">
              <div fxLayout="column">

                <div class="display-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Service Address: '}}
                  </div>
                  <div class="field-data">
                    {{accounts.address.streetAddress ?? ''}}
                  </div>
                </div>

                <div class="display-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Account #: '}}
                  </div>
                  <div class="field-data">
                    {{accounts.accountNumber}}
                  </div>
                </div>
                <div class="group-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Site #: '}}
                  </div>
                  <div class="field-data">
                    {{accounts.siteNumber}}
                  </div>
                </div>

                <div class="display-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Container: '}}
                  </div>
                  <div class="field-data">
                    {{'(' + accounts.container.count + ')'}}&nbsp;{{accounts.container.size}}&nbsp;{{accounts.container.unit}}&nbsp;{{accounts.container.type}}
                  </div>
                </div>
                <div class="group-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Min. Containers Per Service: '}}
                  </div>
                  <div class="field-data">
                    {{accounts.container.minimumPerService}}
                  </div>
                </div>
                <div class="group-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Frequency: '}}
                  </div>
                  <div class="field-data">
                    {{'Every ' + accounts.container.frequencyByWeeks + ' Weeks'}}
                  </div>
                </div>
                <div class="group-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Price per Box: '}}
                  </div>
                  <div class="field-data">
                    {{accounts.container.price | currency}}

                  </div>
                </div>

                <div class="display-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Expected Bill Amount: '}}
                  </div>
                  <div class="field-data">
                    {{accounts.container.monthlyCost | currency}}
                  </div>
                </div>

                <div class="display-row" fxFlex="row" fxLayoutAlign="start end">
                  <div class="field-label" fxFlex="30">
                    {{'Extra Box Amount (Cust): '}}
                  </div>
                  <div class="field-data" fxFlex="7">
                    {{accounts.container.extraBoxCostCustomer | currency}}
                  </div>


                  <input #extraBoxesCustomerInput (focus)="extraBoxesCustomerInput.select()"
                         [(ngModel)]="extraBoxesCustomer"
                         fxFlex="5"
                         matInput
                         placeholder="0"
                         type="number">

                  <div>&nbsp;</div>
                  <div>&nbsp;</div>

                  <div class="field-data" fxFlex="10">
                    {{calcExtraCustomer(accounts.container.extraBoxCostCustomer) | currency}}
                  </div>
                  <!--                    <div *ngIf="compareDates(selectedCustomer.customerApiDate)" class="rainbow-text" fxFlex="15">*Update-->
                  <!--                      Pricing*-->
                  <!--                    </div>-->
                  <!--                    this was cool - use it somewhere else-->

                </div>
                <div class="group-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Extra Box Amount (Hauler): '}}
                  </div>
                  <div class="field-data" fxFlex="7">
                    {{accounts.container.extraBoxCostHauler | currency}}

                  </div>

                  <input #extraBoxesHaulerInput (focus)="extraBoxesHaulerInput.select()"
                         [(ngModel)]="extraBoxesHauler"
                         fxFlex="5"
                         matInput
                         placeholder="0"
                         type="number">

                  <div>&nbsp;</div>
                  <div>&nbsp;</div>

                  <div class="field-data" fxFlex="10">
                    {{calcExtraHauler(accounts.container.extraBoxCostHauler) | currency}}
                  </div>

                  <!--                    <div *ngIf="compareDates(selectedCustomer.haulerApiDate)" class="rainbow-text" fxFlex="15">*Update-->
                  <!--                      Pricing*-->
                  <!--                    </div>-->

                </div>

                <div class="display-row" fxFlex="row" fxLayoutAlign="start end">
                  <div class="field-label" fxFlex="30">
                    {{'Customer Start: '}}
                  </div>
                  <div class="field-data" fxFlex="40">
                    {{selectedCustomer.customerApiDate | date:'MM/dd/yy'}}
                    - {{accounts.container.extraBoxCostCustomerOriginal | currency}}
                  </div>

                </div>
                <div class="display-row" fxLayout="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Customer APIs: ' + '@' + selectedCustomer.customerApiRate + '%'}}
                  </div>
                  <div class="field-data" fxFlex="40" fxLayout="column">
                    <div>
                      {{addOneYear(selectedCustomer) | date:'MM/dd/yy'}}
                      - {{addOneApi(accounts.container.extraBoxCostCustomerOriginal, selectedCustomer.customerApiRate) | currency}}
                    </div>
                    <div>
                      {{addTwoYears(selectedCustomer) | date:'MM/dd/yy'}}
                      - {{addTwoApis(accounts.container.extraBoxCostCustomerOriginal, selectedCustomer.customerApiRate) | currency}}
                    </div>

                  </div>


                </div>

                <div class="display-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Hauler Start: '}}
                  </div>
                  <div class="field-data" fxFlex="40">
                    {{selectedCustomer.haulerApiDate  | date:'MMMM dd, yyyy'}}
                  </div>

                </div>


                <div class="display-row" fxFlex="row" fxLayoutAlign="start">
                  <div class="field-label" fxFlex="30">
                    {{'Notes: '}}
                  </div>
                  <div fxFlex="column">
                    <div *ngFor="let note of accounts.notes">
                      <div>{{note}}</div>
                    </div>
                    <div #deleteButton>
                      <button
                        (click)="confirmDeleteButton.disabled = false; denyButton.disabled = false; confirmButtons.hidden = false; deleteButton.hidden = true"

                        class="delete-button"
                        color="primary"
                        mat-raised-button>
                        Delete
                        On-Call Account
                      </button>
                    </div>
                    <div #confirmButtons [hidden]="true">
                      <button #denyButton
                              (click)="confirmDeleteButton.disabled = true; denyButton.disabled = true; confirmButtons.hidden = true; deleteButton.hidden = false"
                              [disabled]="true"
                              class="deny-button"
                              color="primary" mat-raised-button>
                        Abort
                      </button>
                      <button #confirmDeleteButton
                              (click)="onConfirmDeleteAccount(accounts, customer)"
                              [disabled]="true"
                              class="confirm-button"
                              color="primary" mat-raised-button> Confirm
                      </button>
                    </div>


                  </div>
                </div>


              </div>
            </div>

          </mat-tab>


        </mat-tab-group>


        <div>

        </div>
      </mat-card-content>

    </mat-card>
  </div>
</div>

